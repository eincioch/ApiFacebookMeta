@page "/facebook-login"
@inject HttpClient Http
@inject IJSRuntime JS 

@rendermode InteractiveServer

<PageTitle>Facebook</PageTitle>

<h1>Login con Facebook</h1>

<button class="btn btn-primary" @onclick="LoginFacebook">Iniciar sesión con Facebook</button>


@* <p role="status">Current count: @currentCount</p>
<button class="btn btn-primary" @onclick="IncrementCount">Click me</button> *@


@if (!string.IsNullOrEmpty(Token))
{
    <p>Short-lived token: @Token</p>
}

@code {
    public string Token { get; set; }
    public string LongLivedToken { get; set; }

    private int currentCount = 0;

    private void IncrementCount()
    {
        currentCount++;
    }

    private bool scriptsLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !scriptsLoaded)
        {
            // Carga el SDK de Facebook
            await JS.InvokeVoidAsync("eval", @"
                if (!window.fbAsyncInit) {
                    window.fbAsyncInit = function() {
                        FB.init({
                            appId: '248812736348757',
                            cookie: true,
                            xfbml: true,
                            version: 'v23.0'
                        });
                    };
                    (function(d, s, id){
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) {return;}
                        js = d.createElement(s); js.id = id;
                        js.src = 'https://connect.facebook.net/es_ES/sdk.js';
                        fjs.parentNode.insertBefore(js, fjs);
                    }(document, 'script', 'facebook-jssdk'));
                }
            ");

            // Carga tu archivo JS personalizado
            await JS.InvokeVoidAsync("eval", @"
                if (!window.loginWithFacebook) {
                    var script = document.createElement('script');
                    script.src = '/js/facebookLogin.js';
                    document.head.appendChild(script);
                }
            ");

            scriptsLoaded = true;
        }
    }

    private async Task LoginFacebook()
    {
       // verificar si tiene estos permiso https://graph.facebook.com/v23.0/me/permissions?access_token=
        // {
        //     "data": [
        //         { "permission": "pages_manage_posts", "status": "granted" },
        //         { "permission": "pages_read_engagement", "status": "granted" },
        //         { "permission": "public_profile", "status": "granted" }
        //       ]
        //     }
        await JS.InvokeVoidAsync("loginWithFacebook", DotNetObjectReference.Create(this));
    }

    [JSInvokable]
    public Task OnFacebookLogin(string token)
    {
        Token = token;
        StateHasChanged();

        return Task.CompletedTask;

        // if (!string.IsNullOrEmpty(token))
        // {
        //     var response = await Http.PostAsJsonAsync("https://localhost:7296/api/facebookauth/renovar-token", new { shortLivedToken = token });
        //     if (response.IsSuccessStatusCode)
        //     {
        //         var result = await response.Content.ReadFromJsonAsync<TokenResponse>();
        //         LongLivedToken = result?.access_token;
        //     }
        // }
    }

    public class TokenResponse
    {
        public string access_token { get; set; }
    }
}